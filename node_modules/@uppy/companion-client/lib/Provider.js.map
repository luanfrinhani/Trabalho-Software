{"version":3,"sources":["Provider.js"],"names":["qsStringify","require","URL","RequestClient","tokenStorage","_getName","id","split","map","s","charAt","toUpperCase","slice","join","module","exports","uppy","opts","provider","name","pluginId","tokenKey","companionKeysParams","preAuthToken","headers","Promise","all","getAuthToken","then","token","authHeaders","btoa","JSON","stringify","params","onReceiveResponse","response","plugin","getPlugin","oldAuthenticated","getPluginState","authenticated","status","setPluginState","setAuthToken","storage","setItem","getItem","authUrl","queries","uppyPreAuthToken","strigifiedQueries","hostname","fileUrl","fetchPreAuthToken","resolve","post","res","catch","err","log","list","directory","get","logout","removeItem","initPlugin","defaultOpts","type","files","serverUrl","serverPattern","Error","companionAllowedHosts","pattern","Array","isArray","RegExp","TypeError","test","companionUrl","replace","origin"],"mappings":"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","sourcesContent":["'use strict'\n\nconst qsStringify = require('qs-stringify')\nconst URL = require('url-parse')\nconst RequestClient = require('./RequestClient')\nconst tokenStorage = require('./tokenStorage')\n\nconst _getName = (id) => {\n  return id.split('-').map((s) => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')\n}\n\nmodule.exports = class Provider extends RequestClient {\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.provider = opts.provider\n    this.id = this.provider\n    this.name = this.opts.name || _getName(this.id)\n    this.pluginId = this.opts.pluginId\n    this.tokenKey = `companion-${this.pluginId}-auth-token`\n    this.companionKeysParams = this.opts.companionKeysParams\n    this.preAuthToken = null\n  }\n\n  headers () {\n    return Promise.all([super.headers(), this.getAuthToken()])\n      .then(([headers, token]) => {\n        const authHeaders = {}\n        if (token) {\n          authHeaders['uppy-auth-token'] = token\n        }\n\n        if (this.companionKeysParams) {\n          authHeaders['uppy-credentials-params'] = btoa(\n            JSON.stringify({ params: this.companionKeysParams })\n          )\n        }\n        return { ...headers, ...authHeaders }\n      })\n  }\n\n  onReceiveResponse (response) {\n    response = super.onReceiveResponse(response)\n    const plugin = this.uppy.getPlugin(this.pluginId)\n    const oldAuthenticated = plugin.getPluginState().authenticated\n    const authenticated = oldAuthenticated ? response.status !== 401 : response.status < 400\n    plugin.setPluginState({ authenticated })\n    return response\n  }\n\n  // @todo(i.olarewaju) consider whether or not this method should be exposed\n  setAuthToken (token) {\n    return this.uppy.getPlugin(this.pluginId).storage.setItem(this.tokenKey, token)\n  }\n\n  getAuthToken () {\n    return this.uppy.getPlugin(this.pluginId).storage.getItem(this.tokenKey)\n  }\n\n  authUrl (queries = {}) {\n    if (this.preAuthToken) {\n      queries.uppyPreAuthToken = this.preAuthToken\n    }\n\n    let strigifiedQueries = qsStringify(queries)\n    strigifiedQueries = strigifiedQueries ? `?${strigifiedQueries}` : strigifiedQueries\n    return `${this.hostname}/${this.id}/connect${strigifiedQueries}`\n  }\n\n  fileUrl (id) {\n    return `${this.hostname}/${this.id}/get/${id}`\n  }\n\n  fetchPreAuthToken () {\n    if (!this.companionKeysParams) {\n      return Promise.resolve()\n    }\n\n    return this.post(`${this.id}/preauth/`, { params: this.companionKeysParams })\n      .then((res) => {\n        this.preAuthToken = res.token\n      }).catch((err) => {\n        this.uppy.log(`[CompanionClient] unable to fetch preAuthToken ${err}`, 'warning')\n      })\n  }\n\n  list (directory) {\n    return this.get(`${this.id}/list/${directory || ''}`)\n  }\n\n  logout () {\n    return this.get(`${this.id}/logout`)\n      .then((response) => Promise.all([\n        response,\n        this.uppy.getPlugin(this.pluginId).storage.removeItem(this.tokenKey),\n      ])).then(([response]) => response)\n  }\n\n  static initPlugin (plugin, opts, defaultOpts) {\n    plugin.type = 'acquirer'\n    plugin.files = []\n    if (defaultOpts) {\n      plugin.opts = { ...defaultOpts, ...opts }\n    }\n\n    if (opts.serverUrl || opts.serverPattern) {\n      throw new Error('`serverUrl` and `serverPattern` have been renamed to `companionUrl` and `companionAllowedHosts` respectively in the 0.30.5 release. Please consult the docs (for example, https://uppy.io/docs/instagram/ for the Instagram plugin) and use the updated options.`')\n    }\n\n    if (opts.companionAllowedHosts) {\n      const pattern = opts.companionAllowedHosts\n      // validate companionAllowedHosts param\n      if (typeof pattern !== 'string' && !Array.isArray(pattern) && !(pattern instanceof RegExp)) {\n        throw new TypeError(`${plugin.id}: the option \"companionAllowedHosts\" must be one of string, Array, RegExp`)\n      }\n      plugin.opts.companionAllowedHosts = pattern\n    } else {\n      // does not start with https://\n      if (/^(?!https?:\\/\\/).*$/i.test(opts.companionUrl)) {\n        plugin.opts.companionAllowedHosts = `https://${opts.companionUrl.replace(/^\\/\\//, '')}`\n      } else {\n        plugin.opts.companionAllowedHosts = new URL(opts.companionUrl).origin\n      }\n    }\n\n    plugin.storage = plugin.opts.storage || tokenStorage\n  }\n}\n"]}